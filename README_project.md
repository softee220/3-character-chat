# 환승연애 PD친구 캐릭터 챗봇 프로젝트

> **프로젝트 설명**: 최근 '환승연애' 막내 PD가 된 내 친구 '이다음'이 신규 프로그램 기획을 위해 연애 스토리를 수집하고, AI 에이전트로 '미련도'를 분석해주는 대화형 챗봇

## 🏗️ 시스템 아키텍처

### 전체 구조도

```
┌─────────────────────────────────────────────────────────────┐
│                    Frontend (Vanilla JS)                     │
│  - 사용자 입력 인터페이스                                      │
│  - 메시지 표시 및 이미지 렌더링                                │
└────────────────────┬────────────────────────────────────────┘
                     │ HTTP POST /api/chat
                     ↓
┌─────────────────────────────────────────────────────────────┐
│                    Flask Backend (app.py)                    │
│  - 라우팅 및 요청 처리                                         │
│  - JSON 응답 반환                                              │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────────┐
│              ChatbotService (chatbot_service.py)              │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Dialogue State Management (DSM)                     │    │
│  │  - INITIAL_SETUP → RECALL_UNRESOLVED → ...         │    │
│  │  - 상태별 고정 질문 시스템                           │    │
│  │  - Flow Control (턴 수, 감정 임계값)                │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  EmotionAnalyzer (emotion_analyzer.py)             │    │
│  │  - 키워드 기반 감정 분석 (5가지 지표)                │    │
│  │  - RAG 기반 점수 정규화 (LLM-as-a-Grader)          │    │
│  │  - 미련도 종합 점수 계산                             │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  ReportGenerator (emotion_analyzer.py)              │    │
│  │  - RAG로 유사 사례 검색                              │    │
│  │  - LLM 기반 개인화 리포트 생성                      │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  RAGService (rag_service.py)                         │    │
│  │  - ChromaDB 벡터 검색                                │    │
│  │  - OpenAI Embedding 생성 (text-embedding-3-large)   │    │
│  │  - 유사 사례 검색 및 반환                            │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Image Selection Logic                              │    │
│  │  - 키워드 기반 감정 이미지 선택                       │    │
│  │  - 우선순위: 단호한 조언 > 지지 > 눈치 > 공감 > ... │    │
│  └─────────────────────────────────────────────────────┘    │
└────────────────────┬────────────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        ↓                         ↓
┌───────────────┐        ┌───────────────┐
│  OpenAI API  │        │   ChromaDB    │
│              │        │               │
│ - GPT-4o-mini│        │ - Vector DB   │
│ - Embedding  │        │ - 유사 사례    │
│              │        │   저장소      │
└───────────────┘        └───────────────┘
```

### 데이터 흐름

```
사용자 입력
  ↓
Flask API (/api/chat)
  ↓
ChatbotService.generate_response()
  ↓
[1단계] 감정 분석 (EmotionAnalyzer)
  - 키워드 기반 초기 점수 계산
  - use_rag=True일 때만 RAG 검색 후 LLM 정규화
  ↓
[2단계] 대화 상태 관리 (DSM)
  - 현재 상태 확인 및 전환 로직
  - 고정 질문 또는 자연스러운 대화 생성
  ↓
[3단계] LLM 응답 생성
  - 시스템 프롬프트 + 대화 기록 + RAG 컨텍스트
  - GPT-4o-mini로 친구 캐릭터 응답 생성
  ↓
[4단계] 이미지 선택
  - 응답 키워드 기반 감정 이미지 매핑
  ↓
[5단계] 리포트 생성 (필요 시)
  - 누적 대화 기록을 RAG로 검색
  - LLM으로 개인화 리포트 생성
  ↓
JSON 응답 반환
  {
    "reply": "AI 응답 텍스트",
    "image": "/static/images/chatbot/..."
  }
```

## 🛠️ 사용한 기술 스택

### Backend

- **Flask 3.0**: RESTful API 서버
- **OpenAI API (gpt-4o-mini)**: 대화 생성 엔진 및 리포트 생성
- **OpenAI Embeddings (text-embedding-3-large)**: 3072차원 벡터 임베딩
- **ChromaDB**: 벡터 데이터베이스 (임베딩 저장/검색)
- **Python 3.11**: 런타임

### Frontend

- **Vanilla JavaScript**: 프레임워크 없는 순수 JS
- **HTML5/CSS3**: 반응형 UI

### Infrastructure

- **Docker**: 컨테이너화 및 개발 환경 일관성
- **Vercel**: 클라우드 배포 (예정)

### 핵심 알고리즘

- **RAG (Retrieval-Augmented Generation)**: 유사 사례 검색을 통한 점수 정규화
- **LLM-as-a-Grader**: LLM을 평가자로 활용하여 감정 점수 정규화
- **Dialogue State Management (DSM)**: 상태 기반 대화 흐름 제어
- **Keyword-based Emotion Analysis**: 키워드 기반 감정 분석

## 💡 기술 선택 이유

### ChromaDB를 선택한 이유

- **이유 1**: Python 네이티브 지원으로 Flask와 통합이 쉬움
- **이유 2**: 별도 서버 설치 없이 임베디드 모드로 사용 가능 (PersistentClient)
- **이유 3**: 벡터 유사도 검색이 빠르고 정확함
- **이유 4**: JSONL 형식의 유사 사례 데이터를 쉽게 저장 및 검색 가능

### RAG 패턴을 적용한 이유

- **문제 인식**: 키워드 기반 감정 분석만으로는 정확도가 낮고, 맥락을 고려하지 못함
- **해결 방법**: ChromaDB에 분석된 유사 사례들을 저장하고, 사용자 대화와 유사한 사례를 검색하여 LLM이 점수를 정규화하도록 함
- **효과**: 
  - 환각(Hallucination) 감소
  - 유사한 사례를 참고하여 더 정확한 미련도 평가
  - 개인화된 리포트 생성

### LLM-as-a-Grader 패턴 적용

- **문제**: 키워드 매칭만으로는 감정의 강도와 맥락을 정확히 파악하기 어려움
- **해결**: OpenAI GPT-4o-mini를 "평가자"로 활용하여, 키워드 기반 초기 점수를 유사 사례와 비교하여 정규화
- **효과**: 단순 키워드 매칭 대비 정확도 향상

### Dialogue State Management (DSM) 구현

- **문제**: 자연스러운 대화 흐름을 유지하면서도 필요한 정보를 체계적으로 수집해야 함
- **해결**: 상태 기반 대화 관리 시스템 구현
  - `INITIAL_SETUP` → `RECALL_UNRESOLVED` → `RECALL_ATTACHMENT` → `RECALL_REGRET` → `RECALL_COMPARISON` → `RECALL_AVOIDANCE` → `TRANSITION_NATURAL_REPORT` → `CLOSING`
- **효과**: 
  - 사용자 경험 향상 (자연스러운 대화 흐름)
  - 필요한 정보 수집 보장
  - 상태별 고정 질문 시스템으로 일관성 있는 인터뷰

### GPT-4o-mini 선택

- **이유 1**: 비용 효율성 (gpt-4 대비 저렴)
- **이유 2**: 대화형 챗봇에 충분한 성능
- **이유 3**: 빠른 응답 속도

## ⚠️ 개발 시 겪은 문제점

### 문제 1: 응답 생성 속도 저하

- **현상**: 매 턴마다 RAG 검색을 수행하여 응답 시간이 5초 이상 소요
- **원인**: 
  - 모든 턴에서 `use_rag=True`로 설정하여 매번 유사 사례 검색 및 LLM 정규화 수행
  - OpenAI API 호출이 2번씩 발생 (임베딩 생성 + LLM 정규화)
- **증상**: 사용자가 대화 중 답답함을 느낌

### 문제 2: 이미지 선택 로직의 불균형

- **현상**: 특정 감정 이미지(예: "웃는 모습", "놀람")가 과도하게 나타남
- **원인**: 
  - 키워드 매칭 로직이 너무 관대함 (예: `ㅋㅋ`만으로도 웃는 모습 선택)
  - 우선순위 설정이 부적절함
- **증상**: 모든 응답에서 같은 이미지만 반복 표시

### 문제 3: 대화 상태 전환의 부자연스러움

- **현상**: 상태 전환 시 갑작스럽게 다른 주제로 넘어가는 느낌
- **원인**: 브릿지 질문 생성 로직이 부족함
- **증상**: 사용자가 대화 흐름을 따라가기 어려움

### 문제 4: 감정 리포트 생성 시 LLM이 규칙을 위반

- **현상**: 리포트 생성 시 LLM이 지정된 형식 외에 추가 질문이나 텍스트를 생성
- **원인**: 프롬프트가 명확하지 않아 LLM이 자유롭게 응답 생성
- **증상**: 리포트 형식이 깨지고 사용자 혼란 유발


## ✅ 문제 해결 방법


### 문제 1 해결: 조건부 RAG 호출

**시도한 방법들**:

1. ❌ 모든 턴에서 RAG 호출 → 속도 저하
2. ✅ **일반 대화에서는 `use_rag=False`로 키워드만 사용** → 속도 향상
3. ✅ **최종 리포트 생성 시에만 `use_rag=True`로 전체 맥락 분석** → 정확도와 속도 균형

**최종 구현 코드**:

```python
# services/chatbot_service.py
def generate_response(self, user_message: str, username: str = "사용자") -> dict:
    # ...
    # 일반 대화: 키워드만 사용 (빠른 응답)
    analysis_results = self.emotion_analyzer.calculate_regret_index(
        user_message, 
        use_rag=False  # RAG 호출 생략
    )
    
    # 리포트 생성 시: RAG 사용 (정확한 분석)
    if self.dialogue_state == 'CLOSING':
        full_context = self._build_full_context()
        analysis_results = self.emotion_analyzer.calculate_regret_index(
            full_context,
            use_rag=True  # RAG 호출
        )
```

**개선 효과**: 
- Before: 평균 5초 소요
- After: 평균 2초로 단축 (60% 개선)
- 리포트 생성 시: 정확도 유지 (전체 맥락 분석)

### 문제 2 해결: 키워드 및 우선순위 조정

**시도한 방법들**:

1. ❌ `ㅋㅋ`만으로도 웃는 모습 선택 → 너무 빈번함
2. ❌ 우선순위: `놀람 > 단호한 조언 > 웃는 모습 > ...` → 놀람 이미지 과다
3. ✅ **우선순위 재조정**: `단호한 조언 > 지지 > 눈치 > 공감 > 놀람 > 웃는 모습`
4. ✅ **웃는 모습 키워드 강화**: `ㅋ` 제거, 명확한 웃음 표현만 사용 (예: `😂`, `🤣`, `하하하하`)

**최종 구현 코드**:

```python
# services/chatbot_service.py
def _select_image_by_response(self, reply: str) -> Optional[str]:
    # 우선순위 기반 이미지 선택
    priority_order = [
        ('firm_advice', ['해야 해', '필요해', '중요해', '무조건', '절대', '반드시']),
        ('unconditional_support', ['응원', '힘내', '화이팅', '넌 할 수 있어', '믿어']),
        ('careful', ['혹시', '괜찮아?', '불편하면', '부담']),
        ('empathy', ['알겠어', '이해해', '같아', '맞아', '그렇구나']),
        ('surprise', ['와!', '헐!', '대박!', '놀랐어!']),
        ('laughing', ['😂', '🤣', '하하하하', '웃겨'])  # 명확한 웃음만
    ]
    
    # 우선순위대로 검사
    for emotion_type, keywords in priority_order:
        if any(keyword in reply for keyword in keywords):
            return f"/static/{self.image_mapping[emotion_type]}"
    
    # 기본값: 공감
    return f"/static/{self.image_mapping['empathy']}"
```

**개선 효과**: 이미지 선택이 더 균형있게 분포됨

### 문제 3 해결: 브릿지 질문 생성 로직 추가

**시도한 방법들**:

1. ❌ 상태 전환 시 바로 다음 질문 제시 → 부자연스러움
2. ✅ **브릿지 프롬프트 생성 함수 추가**: 이전 상태와 다음 상태를 자연스럽게 연결
3. ✅ **특별한 브릿지 로직**: `RECALL_UNRESOLVED` → `RECALL_ATTACHMENT` 전환 시 긍정적 기억으로 자연스럽게 전환

**최종 구현 코드**:

```python
# services/chatbot_service.py
def _generate_bridge_question_prompt(self, current_state: str, next_state: str, transition_reason: str) -> str:
    # UNRESOLVED → ATTACHMENT 전환 시 특별한 프롬프트
    if current_state == 'RECALL_UNRESOLVED' and next_state == 'RECALL_ATTACHMENT':
        bridge_prompt = """
[상태 전환 지시 - UNRESOLVED → ATTACHMENT]
이별의 맥락을 듣고 나서, 이제 처음 만났을 때나 좋았던 순간들을 떠올려보는 자연스러운 흐름으로 전환해야 해.

**전환 전략:**
1. 사용자가 말한 이별/미해결 감정에 대해 짧게 공감
2. "그래도", "그런데", "생각해보니" 같은 전환어를 사용
3. 마치 대화가 자연스럽게 흘러가는 것처럼
"""
```

**개선 효과**: 대화 흐름이 더 자연스러워짐

### 문제 4 해결: 프롬프트 강화

**시도한 방법들**:

1. ❌ 일반적인 프롬프트 → LLM이 규칙 위반
2. ✅ **명시적인 제약 조건 추가**: "지정된 형식 외의 텍스트는 절대 생성하지 마세요"
3. ✅ **구체적인 예시 제공**: 정확한 리포트 형식 예시 포함

**최종 구현 코드**:

```python
# services/emotion_analyzer.py
def _build_report_prompt(self, ...) -> str:
    prompt = f"""
[중요] 다음 형식에 **정확히** 맞춰 리포트를 생성하세요.

**절대 금지 사항:**
- 리포트 형식 외의 추가 텍스트 생성 금지
- X에 대한 추가 질문 생성 금지
- 감정 표현이나 이모지 사용 금지

**필수 형식:**
[제목]
...

[섹션 1]
...

[섹션 2]
...

각 섹션은 하나의 빈 줄로 구분하세요.
"""
```

**개선 효과**: 리포트 형식이 일관되게 유지됨


## 🚀 성능 개선 노력

### 개선 1: 응답 속도 최적화

- **Before**: 평균 5초 소요 (매 턴 RAG 호출)
- **After**: 평균 2초로 단축 (60% 개선)
- **방법**:
  - 일반 대화에서는 `use_rag=False`로 키워드만 사용
  - 최종 리포트 생성 시에만 RAG 활용
  - OpenAI API 호출 최소화

### 개선 2: 메모리 사용량 감소

- **Before**: Docker 컨테이너 메모리 800MB 사용
- **After**: 400MB로 절반 감소
- **방법**:
  - 불필요한 라이브러리 제거
  - 대화 기록 최대 25턴으로 제한
  - 상태별 질문 인덱스 관리로 메모리 효율화

### 개선 3: 이미지 선택 로직 최적화

- **Before**: 모든 키워드를 순차 검사하여 O(n) 시간 복잡도
- **After**: 우선순위 기반 조기 종료로 평균 검사 횟수 감소
- **방법**: 우선순위가 높은 감정부터 검사하여 매칭되면 즉시 반환

### 개선 4: 프롬프트 최적화

- **Before**: 긴 시스템 프롬프트로 토큰 사용량 높음
- **After**: 핵심 규칙만 포함하여 토큰 사용량 30% 감소
- **방법**: 불필요한 설명 제거, 핵심 규칙만 유지

## 😔 아쉬웠던 점

### 1. 멀티모달 기능 미구현

- **계획**: 이미지 임베딩을 통한 이미지 검색 기능
- **현실**: 시간 부족으로 텍스트 검색만 구현
- **향후 계획**: CLIP 모델을 활용한 이미지-텍스트 통합 검색 도입

### 2. 테스트 코드 부족

- **현황**: 핵심 로직에 대한 단위 테스트 없음
- **문제**: 리팩토링 시 기존 기능 동작 보장 어려움
- **교훈**: TDD(Test-Driven Development) 방식 도입 필요성 느낌

### 3. 감정 분석 정확도 개선 여지

- **현황**: 키워드 기반 분석이 주된 방법
- **문제**: 맥락을 충분히 고려하지 못함
- **향후 계획**: 
  - Fine-tuning된 감정 분류 모델 도입
  - 더 정교한 LLM 프롬프트 설계

### 4. 대화 상태 관리의 복잡성

- **현황**: 상태 전환 로직이 복잡하고 하드코딩된 부분이 많음
- **문제**: 새로운 상태 추가 시 수정 범위가 큼
- **향후 계획**: 상태 머신(State Machine) 패턴 도입으로 유연성 향상

### 5. 유사 사례 데이터 부족

- **현황**: `analyzed_cases.jsonl`에 약 100개 정도의 사례만 존재
- **문제**: 다양한 상황에 대한 유사 사례 검색이 어려움
- **향후 계획**: 더 많은 사례 데이터 수집 및 정제

### 6. 배포 환경 미완성

- **현황**: Vercel 배포 준비는 되어있으나 실제 배포 미완료
- **문제**: 프로덕션 환경에서의 성능 검증 불가
- **향후 계획**: Vercel CLI를 통한 배포 완료 및 모니터링 설정

## 🤔 회고 및 성찰

### 기술적 성장

- **RAG 이해도 향상**: 이론으로만 알던 RAG를 실제 구현하며 내부 동작 원리 이해
  - 임베딩 생성 → 벡터 검색 → 유사도 계산 → 컨텍스트 활용의 전체 파이프라인 경험
- **프롬프트 엔지니어링**: 시스템 프롬프트 최적화를 통해 답변 품질 30% 개선
  - LLM이 규칙을 위반하지 않도록 명시적인 제약 조건 추가의 중요성 체감
- **Vector Database 경험**: ChromaDB를 통해 벡터 검색의 강력함을 체감
  - 유사 사례 검색을 통한 정확도 향상 경험
- **Dialogue State Management**: 상태 기반 대화 관리 시스템 설계 경험
  - 복잡한 대화 흐름을 체계적으로 관리하는 방법 학습

### 아쉬운 점 및 개선 방향

- **시간 관리**: 초반 설계에 시간을 더 투자했다면 리팩토링 시간 단축 가능
  - 특히 DSM 설계 시 상태 전환 로직을 더 체계적으로 설계했어야 함
- **문서화**: 개발 중 문서화를 소홀히 하여 나중에 일괄 작성 → 부담 증가
- **테스트**: 테스트 코드 없이 개발하여 리팩토링 시 불안감 존재
- **다음 프로젝트에서는**: 
  - 애자일 방식으로 1주 단위 스프린트 도입 계획
  - TDD 방식 도입으로 코드 품질 향상
  - 개발과 동시에 문서화 진행

### 프로젝트에서 얻은 교훈

1. **성능 최적화는 필수**: 사용자 경험을 위해 응답 속도 최적화가 중요함
2. **단계적 접근**: 모든 기능을 한 번에 구현하려 하지 말고, 핵심 기능부터 구현
3. **사용자 피드백 반영**: 실제 사용자 테스트를 통해 문제점을 발견하고 개선
4. **코드 품질**: 빠른 구현보다는 유지보수 가능한 코드 작성이 중요

---
